<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Desarrollo Municipal 2024-2027 - Alcald√≠a de Guatap√©</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* Estilos adicionales para la nueva estructura */
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #e5e7eb;
            border-top-color: #1e3a8a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }


        .lineas-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .lineas-container h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 16px;
        }
        .lineas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .linea-card {
            background: #f8fafc;
            border-left: 5px solid #1e3a8a;
            border-radius: 8px;
            padding: 16px;
            cursor: default;
        }
        .linea-total { background: #eff6ff; }
        .linea-nombre {
            font-size: 13px;
            color: #374151;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .linea-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #6b7280;
        }

        /* Tabla de a√±os */
        .anios-container { margin: 16px 0; }
        .tabla-anios-wrapper { overflow-x: auto; }
        .tabla-anios {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .tabla-anios th {
            background: #1e3a8a;
            color: white;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
        }
        .tabla-anios td {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .tabla-anios tr:last-child td { border-bottom: none; }
        .tabla-anios tr:hover { background: #f8fafc; }

        /* Badge bueno */
        .badge-good {
            background-color: #dcfce7;
            color: #166534;
        }

        /* Secretar√≠a detalle header */
        .secretaria-detalle-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
        }
        .secretaria-detalle-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
    </style>
</head>
<body>
<!-- NAV TABLEROS FLOTANTE -->
<style>
.nav-tableros{position:fixed;bottom:30px;right:30px;z-index:9999;}
.nav-tableros-btn{width:56px;height:56px;border-radius:50%;background:#1e3a8a;color:white;border:3px solid white;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.35);transition:transform 0.2s;}
.nav-tableros-btn:hover{transform:scale(1.12);}
.nav-tableros-menu{display:none;position:absolute;bottom:68px;right:0;background:white;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.22);min-width:230px;border:3px solid #1e3a8a;overflow:hidden;}
.nav-tableros-menu.show{display:block;}
.nav-tableros-menu-title{background:#1e3a8a;color:white;padding:10px 18px;font-weight:700;font-size:13px;letter-spacing:0.5px;}
.nav-tableros-menu a{display:flex;align-items:center;gap:10px;padding:11px 18px;text-decoration:none;font-weight:600;font-size:14px;color:#1e3a8a;border-bottom:1px solid #f0f0f0;transition:background 0.15s;}
.nav-tableros-menu a:last-child{border-bottom:none;}
.nav-tableros-menu a:hover{background:#eff6ff;}
.nav-tableros-menu a.nav-current{background:#dbeafe;font-weight:800;}
</style>
<div class="nav-tableros" id="navTableroPrincipal">
  <button class="nav-tableros-btn" onclick="document.getElementById('navTableroPrincipal').querySelector('.nav-tableros-menu').classList.toggle('show')" title="Navegar entre tableros">üß≠</button>
  <div class="nav-tableros-menu">
    <div class="nav-tableros-menu-title">üìç Navegar entre tableros</div>
    <a href="../index.html">üè† &nbsp;Inicio</a>
    <a href="../plan%20de%20desarrollo/plan_de_desarrollo.html" class="nav-current">üìä &nbsp;Plan de Desarrollo</a>
    <a href="../tablero%20hacienda/hacienda.html">üí∞ &nbsp;Tablero Recaudo</a>
    <a href="../tablero%20compromisos/dashboard-guatape.html">üìã &nbsp;Tablero Compromisos</a>
  </div>
</div>
<script>
document.addEventListener('click',function(e){var n=document.getElementById('navTableroPrincipal');if(n&&!n.contains(e.target)){var m=n.querySelector('.nav-tableros-menu');if(m)m.classList.remove('show');}});
</script>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <img 
                    src="img/logopng.png"
                    alt="Escudo de Guatap√©"
                    class="logo-img"
                    onerror="this.style.display='none'"
                />
            </div>
            <h2 class="sidebar-title">Plan de Desarrollo Municipal</h2>
            <p class="sidebar-subtitle">Guatap√©, Antioquia ‚Ä¢ 2024-2027</p>
        </div>

        <nav class="sidebar-nav">
            <div class="menu-section" style="color:#9ca3af;font-size:10px;letter-spacing:1px;">MEN√ö PRINCIPAL</div>
            <a class="menu-item" href="../index.html" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;border-bottom:1px solid rgba(255,255,255,0.08);padding-bottom:4px;">
                <span class="menu-icon">üè†</span>
                <span>Inicio / Portal</span>
            </a>
            <a class="menu-item" href="../tablero%20hacienda/hacienda.html" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;">
                <span class="menu-icon">üí∞</span>
                <span>Tablero Recaudo</span>
            </a>
            <a class="menu-item" href="../tablero%20compromisos/dashboard-guatape.html" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:8px;">
                <span class="menu-icon">üìã</span>
                <span>Tablero Compromisos</span>
            </a>
            <div class="menu-section">Vista General</div>
            <button class="menu-item active" onclick="cambiarVista('resumen')" data-vista="resumen">
                <span class="menu-icon">üìä</span>
                <span>Resumen Ejecutivo</span>
            </button>

            <div class="menu-section">Secretar√≠as</div>
            <button class="menu-item" onclick="verSecretaria('Secretaria de Gobierno')" data-secretaria="Secretaria de Gobierno">
                <span class="menu-icon">üèõÔ∏è</span>
                <span>Secretar√≠a de Gobierno</span>
            </button>
            <button class="menu-item" onclick="verSecretaria('Sec de Bienestar y Dllo Social')" data-secretaria="Sec de Bienestar y Dllo Social">
                <span class="menu-icon">üë•</span>
                <span>Bienestar y Desarrollo Social</span>
            </button>
            <button class="menu-item" onclick="verSecretaria('Secretaria de Turismo')" data-secretaria="Secretaria de Turismo">
                <span class="menu-icon">üèñÔ∏è</span>
                <span>Secretar√≠a de Turismo</span>
            </button>
            <button class="menu-item" onclick="verSecretaria('Sec Planeacion y Obras Pub')" data-secretaria="Sec Planeacion y Obras Pub">
                <span class="menu-icon">üèóÔ∏è</span>
                <span>Planeaci√≥n y Obras P√∫blicas</span>
            </button>
            <button class="menu-item" onclick="verSecretaria('Sec Medio Ambiente y Dllo Rural')" data-secretaria="Sec Medio Ambiente y Dllo Rural">
                <span class="menu-icon">üåø</span>
                <span>Medio Ambiente y Desarrollo Rural</span>
            </button>
        </nav>

        <div class="sidebar-footer">
            <p id="firebase-status" style="color:#9ca3af;font-size:11px;margin-bottom:4px;">üîÑ Conectando a Firebase...</p>
            <p>¬© 2025 Alcald√≠a Municipal de Guatap√©, Antioquia</p>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">
        <header class="main-header">
            <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">‚ò∞</button>
            <h1 class="main-title">Plan de Desarrollo Municipal "Juntos Construimos 2024-2027"</h1>
        </header>

        <div class="content-area" id="contentArea">
            <div style="display:flex;align-items:center;justify-content:center;min-height:400px;flex-direction:column;gap:20px;">
                <div class="spinner"></div>
                <p style="color:#1e3a8a;font-size:18px;font-weight:600;">Iniciando tablero...</p>
            </div>
        </div>
    </main>

    <!-- Datos locales (fallback y carga inicial Firebase) -->
    <script src="js/datos.js"></script>

    <!-- App principal como m√≥dulo ES para Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, collection, getDocs, setDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzP_NnuPmewAeOJ7IkJxkiSrHgpObz4cQ",
            authDomain: "plan-de-desarrollo-49495.firebaseapp.com",
            projectId: "plan-de-desarrollo-49495",
            storageBucket: "plan-de-desarrollo-49495.firebasestorage.app",
            messagingSenderId: "374569479398",
            appId: "1:374569479398:web:f718e47ee0ae0d8a439f27"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============================================================
        // ESTADO GLOBAL
        // ============================================================
        window.programasDB = [];
        window.consolidadoDB = [];
        window.semaforoFiltro = null;

        // ============================================================
        // FIREBASE
        // ============================================================
        async function subirDatosIniciales() {
            const batchSize = 400;
            const progs = window.DATOS_PROGRAMAS;

            for (let i = 0; i < progs.length; i += batchSize) {
                const batch = writeBatch(db);
                progs.slice(i, i + batchSize).forEach((prog, j) => {
                    const ref = doc(db, 'programas', `prog_${String(i+j).padStart(3,'0')}`);
                    batch.set(ref, prog);
                });
                await batch.commit();
            }

            const batch2 = writeBatch(db);
            window.CONSOLIDADO_LINEAS.forEach((linea, i) => {
                batch2.set(doc(db, 'consolidado', `linea_${i}`), linea);
            });
            await batch2.commit();

            console.log('‚úÖ Datos subidos a Firebase');
        }

        function usarDatosLocales(statusEl, mensaje) {
            console.warn('Usando datos locales:', mensaje);
            // DATOS_PROGRAMAS y CONSOLIDADO_LINEAS est√°n en window gracias al script datos.js
            if (typeof window.DATOS_PROGRAMAS === 'undefined' || !Array.isArray(window.DATOS_PROGRAMAS)) {
                console.error('DATOS_PROGRAMAS no est√° disponible en window');
                document.getElementById('contentArea').innerHTML = `
                    <div style="padding:40px;text-align:center;color:#ef4444;">
                        <p style="font-size:18px;font-weight:700;">‚ùå Error: No se pudieron cargar los datos</p>
                        <p>Verifica que el archivo <code>js/datos.js</code> est√© correctamente ubicado.</p>
                    </div>`;
                return false;
            }
            window.programasDB = [...window.DATOS_PROGRAMAS];
            window.consolidadoDB = [...window.CONSOLIDADO_LINEAS];
            if (statusEl) statusEl.innerHTML = `‚ö†Ô∏è Modo offline<br><small>${mensaje}</small>`;
            return true;
        }

        async function cargarDatosFirebase() {
            const statusEl = document.getElementById('firebase-status');
            try {
                if (statusEl) statusEl.textContent = 'üîÑ Conectando a Firebase...';

                // Intentar leer de Firebase
                const snap = await getDocs(collection(db, 'programas'));
                window.programasDB = [];
                snap.forEach(d => window.programasDB.push({ id: d.id, ...d.data() }));

                const snapC = await getDocs(collection(db, 'consolidado'));
                window.consolidadoDB = [];
                snapC.forEach(d => window.consolidadoDB.push({ id: d.id, ...d.data() }));

                // Si Firebase est√° vac√≠o, intentar subir datos locales
                if (window.programasDB.length === 0) {
                    if (statusEl) statusEl.textContent = '‚¨ÜÔ∏è Subiendo datos iniciales...';
                    try {
                        await subirDatosIniciales();
                        const snap2 = await getDocs(collection(db, 'programas'));
                        window.programasDB = [];
                        snap2.forEach(d => window.programasDB.push({ id: d.id, ...d.data() }));
                        const snapC2 = await getDocs(collection(db, 'consolidado'));
                        window.consolidadoDB = [];
                        snapC2.forEach(d => window.consolidadoDB.push({ id: d.id, ...d.data() }));
                    } catch (writeErr) {
                        // Sin permisos de escritura ‚Üí usar datos locales
                        console.warn('Sin permisos de escritura en Firebase, usando datos locales:', writeErr.message);
                        if (!usarDatosLocales(statusEl, 'Sin permisos de escritura')) return;
                    }
                }

                if (window.programasDB.length > 0) {
                    if (statusEl) statusEl.innerHTML = `‚úÖ Firebase conectado<br><small>${window.programasDB.length} programas cargados</small>`;
                } else {
                    if (!usarDatosLocales(statusEl, 'Firebase vac√≠o')) return;
                }

                mostrarResumen();

            } catch (err) {
                console.error('Firebase error:', err.code, err.message);
                // Cualquier error de Firebase ‚Üí datos locales
                const msg = err.code === 'permission-denied'
                    ? 'Sin permisos Firebase'
                    : 'Sin conexi√≥n Firebase';
                if (!usarDatosLocales(statusEl, msg)) return;
                mostrarResumen();
            }
        }


        // ============================================================
        // NAVEGACI√ìN
        // ============================================================
        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        };

        window.cambiarVista = function(vista) {
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const el = document.querySelector(`[data-vista="${vista}"]`);
            if (el) el.classList.add('active');
            if (vista === 'resumen') { window.semaforoFiltro = null; mostrarResumen(); }
        };

        window.verSecretaria = function(nombre) {
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const el = document.querySelector(`[data-secretaria="${nombre}"]`);
            if (el) el.classList.add('active');
            mostrarSecretaria(nombre);
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('mobile-open');
        };

        // ============================================================
        // UTILIDADES
        // ============================================================
        function fmt(v) {
            const n = parseFloat(v);
            if (isNaN(n) || n === 0) return '0';
            if (n < 1 && n > 0) return n.toFixed(2);
            return n % 1 === 0 ? n.toString() : n.toFixed(2);
        }

        function colorBorde(pct) {
            if (pct >= 0.8) return '#10b981';
            if (pct >= 0.6) return '#84cc16';
            if (pct >= 0.4) return '#f59e0b';
            return '#ef4444';
        }

        function clasificarPct(pct) {
            if (pct >= 0.8) return 'excelente';
            if (pct >= 0.6) return 'bueno';
            if (pct >= 0.4) return 'regular';
            return 'critico';
        }

        window.filtrarSemaforo = function(tipo) {
            window.semaforoFiltro = (window.semaforoFiltro === tipo) ? null : tipo;
            mostrarResumen();
        };

        window.limpiarFiltroSemaforo = function() {
            window.semaforoFiltro = null;
            mostrarResumen();
        };

        function iconoSec(n) {
            if (!n) return 'üè¢';
            if (n.includes('Gobierno')) return 'üèõÔ∏è';
            if (n.includes('Bienestar') || n.includes('Social')) return 'üë•';
            if (n.includes('Turismo')) return 'üèñÔ∏è';
            if (n.includes('Planeacion') || n.includes('Obras')) return 'üèóÔ∏è';
            if (n.includes('Medio Ambiente') || n.includes('Rural')) return 'üåø';
            return 'üè¢';
        }

        function getSecretarias() {
            const order = ['Secretaria de Gobierno','Sec de Bienestar y Dllo Social','Secretaria de Turismo','Sec Planeacion y Obras Pub','Sec Medio Ambiente y Dllo Rural'];
            const set = new Set(window.programasDB.map(p => p.secretaria));
            return order.filter(s => set.has(s));
        }

        function getProgramas(sec) {
            return window.programasDB.filter(p => p.secretaria === sec);
        }

        function statsGenerales() {
            const progs = window.programasDB;
            const total = progs.length;
            let suma = 0, ex=0, bu=0, re=0, cr=0;
            progs.forEach(p => {
                const pct = parseFloat(p.pct_avance_fecha) || 0;
                suma += pct;
                if (pct >= 0.8) ex++;
                else if (pct >= 0.6) bu++;
                else if (pct >= 0.4) re++;
                else cr++;
            });
            return { total, avancePromedio: total > 0 ? (suma/total)*100 : 0, excelente: ex, bueno: bu, regular: re, critico: cr };
        }

        function statsSecretaria(nombre) {
            const progs = getProgramas(nombre);
            const total = progs.length;
            if (!total) return { total: 0, avancePromedio: 0, completados: 0, enRiesgo: 0 };
            let suma=0, comp=0, riesgo=0;
            progs.forEach(p => {
                const pct = parseFloat(p.pct_avance_fecha) || 0;
                suma += pct;
                if (pct >= 1) comp++;
                if (pct < 0.4) riesgo++;
            });
            return { total, avancePromedio: (suma/total)*100, completados: comp, enRiesgo: riesgo };
        }

        // ============================================================
        // RESUMEN
        // ============================================================
        function mostrarResumen() {
            const stats = statsGenerales();
            const secs = getSecretarias();
            const avPct = stats.avancePromedio.toFixed(1);
            const colorGeneral = colorBorde(stats.avancePromedio/100);

            const consolidadoMap = {};
            window.consolidadoDB.forEach(c => consolidadoMap[c.linea] = c);
            const lineas = window.consolidadoDB.filter(c => c.linea && c.linea !== 'TOTAL');
            const totalLinea = window.consolidadoDB.find(c => c.linea === 'TOTAL');

            let html = `
            <div class="fade-in">
                <div class="dashboard-header">
                    <h2>üìä Resumen Ejecutivo</h2>
                    <div class="dashboard-subtitle">Plan de Desarrollo Municipal "Juntos Construimos 2024-2027"</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon">üìã</div>
                        <div class="kpi-value">${stats.total}</div>
                        <div class="kpi-label">Total Programas</div>
                    </div>
                    <div class="kpi-card kpi-card-wide">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-value">${avPct}%</div>
                        <div class="kpi-label">Avance al Plan de Desarrollo</div>
                        <div class="kpi-progress-mini">
                            <div class="kpi-progress-bar">
                                <div class="kpi-progress-fill" style="width:${Math.min(avPct,100)}%;background:${colorGeneral};"></div>
                            </div>
                            <div class="kpi-progress-labels">
                                <span class="label-avance">‚úì ${avPct}%</span>
                                <span class="label-faltante">‚è≥ ${(100-parseFloat(avPct)).toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">‚úÖ</div>
                        <div class="kpi-value">${stats.excelente}</div>
                        <div class="kpi-label">En Excelente Estado</div>
                        <div class="stat-description">‚â•80%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">‚ö†Ô∏è</div>
                        <div class="kpi-value">${stats.critico}</div>
                        <div class="kpi-label">Estado Cr√≠tico</div>
                        <div class="stat-description">&lt;40%</div>
                    </div>
                </div>

                <div class="semaforo-container">
                    <h3 style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                        <span>üö¶ Sem√°foro de Estado de Programas</span>
                        ${window.semaforoFiltro
                            ? `<button onclick="limpiarFiltroSemaforo()" style="font-size:13px;background:#f3f4f6;border:2px solid #d1d5db;border-radius:8px;padding:7px 18px;cursor:pointer;font-weight:700;color:#374151;transition:all 0.2s;">‚úï Limpiar filtro</button>`
                            : `<span style="font-size:13px;font-weight:400;color:#6b7280;font-style:italic;">Haz clic en una categor√≠a para filtrar los programas</span>`}
                    </h3>
                    <div class="semaforo-grid">
                        <div class="semaforo-item excelente" onclick="filtrarSemaforo('excelente')" style="cursor:pointer;transition:all 0.2s;${window.semaforoFiltro==='excelente'?'box-shadow:0 0 0 4px #10b981,0 8px 24px rgba(16,185,129,0.3);transform:scale(1.06);':''}${window.semaforoFiltro&&window.semaforoFiltro!=='excelente'?'opacity:0.4;filter:grayscale(40%);':''}">
                            <div class="semaforo-icon">üü¢</div><div class="semaforo-label">Excelente</div>
                            <div class="semaforo-count">${stats.excelente}</div>
                            <div class="semaforo-percentage">${((stats.excelente/stats.total)*100).toFixed(1)}%</div>
                            <div style="font-size:12px;color:#059669;margin-top:8px;">‚â• 80% de avance</div>
                        </div>
                        <div class="semaforo-item bueno" onclick="filtrarSemaforo('bueno')" style="cursor:pointer;transition:all 0.2s;${window.semaforoFiltro==='bueno'?'box-shadow:0 0 0 4px #84cc16,0 8px 24px rgba(132,204,22,0.3);transform:scale(1.06);':''}${window.semaforoFiltro&&window.semaforoFiltro!=='bueno'?'opacity:0.4;filter:grayscale(40%);':''}">
                            <div class="semaforo-icon">üü°</div><div class="semaforo-label">Bueno</div>
                            <div class="semaforo-count">${stats.bueno}</div>
                            <div class="semaforo-percentage">${((stats.bueno/stats.total)*100).toFixed(1)}%</div>
                            <div style="font-size:12px;color:#65a30d;margin-top:8px;">60% - 79%</div>
                        </div>
                        <div class="semaforo-item regular" onclick="filtrarSemaforo('regular')" style="cursor:pointer;transition:all 0.2s;${window.semaforoFiltro==='regular'?'box-shadow:0 0 0 4px #f59e0b,0 8px 24px rgba(245,158,11,0.3);transform:scale(1.06);':''}${window.semaforoFiltro&&window.semaforoFiltro!=='regular'?'opacity:0.4;filter:grayscale(40%);':''}">
                            <div class="semaforo-icon">üü†</div><div class="semaforo-label">Regular</div>
                            <div class="semaforo-count">${stats.regular}</div>
                            <div class="semaforo-percentage">${((stats.regular/stats.total)*100).toFixed(1)}%</div>
                            <div style="font-size:12px;color:#d97706;margin-top:8px;">40% - 59%</div>
                        </div>
                        <div class="semaforo-item critico" onclick="filtrarSemaforo('critico')" style="cursor:pointer;transition:all 0.2s;${window.semaforoFiltro==='critico'?'box-shadow:0 0 0 4px #ef4444,0 8px 24px rgba(239,68,68,0.3);transform:scale(1.06);':''}${window.semaforoFiltro&&window.semaforoFiltro!=='critico'?'opacity:0.4;filter:grayscale(40%);':''}">
                            <div class="semaforo-icon">üî¥</div><div class="semaforo-label">Cr√≠tico</div>
                            <div class="semaforo-count">${stats.critico}</div>
                            <div class="semaforo-percentage">${((stats.critico/stats.total)*100).toFixed(1)}%</div>
                            <div style="font-size:12px;color:#dc2626;margin-top:8px;">&lt; 40%</div>
                        </div>
                    </div>
                </div>

                <!-- L√≠neas Estrat√©gicas -->
                <div class="lineas-container">
                    <h3>üéØ Avance por L√≠nea Estrat√©gica</h3>
                    <div class="lineas-grid">
            `;

            lineas.forEach(linea => {
                const pct = parseFloat(linea.pct_avance) || 0;
                const pctDisplay = (pct * 100).toFixed(1);
                const color = colorBorde(pct);
                html += `
                    <div class="linea-card" style="border-left:5px solid ${color}">
                        <div class="linea-nombre">${linea.linea}</div>
                        <div class="linea-stats">
                            <span>${linea.num_programas} programas</span>
                            <span style="color:${color};font-weight:700;">${pctDisplay}%</span>
                        </div>
                        <div class="progress-bar" style="height:8px;margin-top:8px;">
                            <div class="progress-fill" style="width:${Math.min(pctDisplay,100)}%;background:${color};height:8px;border-radius:4px;"></div>
                        </div>
                    </div>`;
            });

            if (totalLinea) {
                const pctT = (parseFloat(totalLinea.pct_avance)||0)*100;
                html += `
                    <div class="linea-card linea-total" style="border-left:5px solid #1e3a8a">
                        <div class="linea-nombre"><strong>TOTAL PLAN DE DESARROLLO</strong></div>
                        <div class="linea-stats">
                            <span>${totalLinea.num_programas} programas</span>
                            <span style="color:#1e3a8a;font-weight:700;">${pctT.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar" style="height:10px;margin-top:8px;">
                            <div class="progress-fill" style="width:${Math.min(pctT,100)}%;background:#1e3a8a;height:10px;border-radius:5px;"></div>
                        </div>
                    </div>`;
            }

            html += `
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card"><h3>üìä Estado de Programas</h3><div class="chart-wrapper"><canvas id="chartEstado"></canvas></div></div>
                    <div class="chart-card"><h3>üè¢ Programas por Secretar√≠a</h3><div class="chart-wrapper"><canvas id="chartSecretarias"></canvas></div></div>
                    <div class="chart-card"><h3>üìà Avance Plan de Desarrollo Juntos Construimos 2024 - 2027</h3><div class="chart-wrapper"><canvas id="chartAvances"></canvas></div></div>
                    <div class="chart-card"><h3>üìÖ Avance Anual Plan de Acci√≥n</h3><div class="chart-wrapper"><canvas id="chartAnios"></canvas></div></div>
                </div>

            `;

            // ========== SECCI√ìN CONDICIONAL: FILTRO SEM√ÅFORO O SECRETAR√çAS ==========
            if (window.semaforoFiltro) {
                const cfMap = {
                    excelente: {bg:'#d1fae5', border:'#10b981', text:'#065f46', label:'Excelente', icon:'üü¢', rango:'‚â• 80%'},
                    bueno:     {bg:'#ecfccb', border:'#84cc16', text:'#3f6212', label:'Bueno',     icon:'üü°', rango:'60% - 79%'},
                    regular:   {bg:'#fef3c7', border:'#f59e0b', text:'#92400e', label:'Regular',   icon:'üü†', rango:'40% - 59%'},
                    critico:   {bg:'#fee2e2', border:'#ef4444', text:'#7f1d1d', label:'Cr√≠tico',   icon:'üî¥', rango:'< 40%'}
                };
                const cf = cfMap[window.semaforoFiltro];
                const progsFiltrados = window.programasDB.filter(p => {
                    const pct = parseFloat(p.pct_avance_fecha) || 0;
                    return clasificarPct(pct) === window.semaforoFiltro;
                });
                html += `
                    <div style="background:${cf.bg};border:2px solid ${cf.border};border-radius:14px;padding:18px 24px;margin:24px 0 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);">
                        <div>
                            <div style="font-weight:700;color:${cf.text};font-size:18px;">${cf.icon} Programas en estado: ${cf.label}</div>
                            <div style="font-size:13px;color:${cf.text};opacity:0.85;margin-top:4px;">Rango de avance: ${cf.rango} ‚Äî <strong>${progsFiltrados.length} programas encontrados</strong></div>
                        </div>
                        <button onclick="limpiarFiltroSemaforo()" style="background:white;border:2px solid ${cf.border};color:${cf.text};border-radius:10px;padding:10px 20px;cursor:pointer;font-weight:700;font-size:14px;">‚úï Limpiar filtro</button>
                    </div>
                `;
                secs.forEach(sec => {
                    const progsDeEsta = progsFiltrados.filter(p => p.secretaria === sec);
                    if (!progsDeEsta.length) return;
                    html += `<h4 style="font-size:17px;font-weight:700;color:#1e3a8a;margin:24px 0 12px;padding:10px 16px;background:${cf.bg};border-left:5px solid ${cf.border};border-radius:8px;">${iconoSec(sec)} ${sec} ‚Äî ${progsDeEsta.length} programa${progsDeEsta.length>1?'s':''}</h4>`;
                    progsDeEsta.forEach((p, i) => { html += renderPrograma(p, i+1); });
                });
            } else {
                html += `<h3 style="font-size:22px;font-weight:700;color:#1e3a8a;margin:32px 0 20px;">üè¢ Secretar√≠as (${secs.length})</h3>`;
                secs.forEach(sec => {
                    const s = statsSecretaria(sec);
                    const color = colorBorde(s.avancePromedio/100);
                    html += `
                        <div class="secretaria-card-mejorada" onclick="verSecretaria('${sec}')" style="border-top-color:${color}">
                            <div class="secretaria-header-mejorada">
                                <span class="secretaria-icono">${iconoSec(sec)}</span>
                                <h3 class="secretaria-titulo">${sec}</h3>
                            </div>
                            <div class="secretaria-stats-grid">
                                <div class="stat-item-secretaria">
                                    <div class="stat-item-label">TOTAL PROGRAMAS</div>
                                    <div class="stat-item-value">${s.total}</div>
                                </div>
                                <div class="stat-item-secretaria stat-item-with-bar">
                                    <div class="stat-item-label">AVANCE AL PLAN</div>
                                    <div class="stat-item-value" style="color:${color}">${s.avancePromedio.toFixed(1)}%</div>
                                    <div class="mini-progress-bar-secretaria">
                                        <div class="mini-progress-fill" style="width:${Math.min(s.avancePromedio,100)}%;background:${color};"></div>
                                    </div>
                                    <div class="mini-progress-labels-secretaria">
                                        <span class="mini-label-avance">‚úì ${s.avancePromedio.toFixed(1)}%</span>
                                        <span class="mini-label-faltante">‚è≥ ${(100-s.avancePromedio).toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div class="stat-item-secretaria">
                                    <div class="stat-item-label">COMPLETADOS</div>
                                    <div class="stat-item-value">${s.completados}</div>
                                    <div class="stat-item-sublabel">‚â•100%</div>
                                </div>
                                <div class="stat-item-secretaria">
                                    <div class="stat-item-label">EN RIESGO</div>
                                    <div class="stat-item-value">${s.enRiesgo}</div>
                                    <div class="stat-item-sublabel">&lt;40%</div>
                                </div>
                            </div>
                        </div>`;
                });
            }
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
            setTimeout(() => renderGraficosResumen(stats, secs), 100);
        }

        function renderGraficosResumen(stats, secs) {
            ['chartEstado','chartAvances','chartSecretarias','chartAnios'].forEach(id => {
                const ex = Chart.getChart(id); if (ex) ex.destroy();
            });

            // Dona estado
            const ctxE = document.getElementById('chartEstado');
            if (ctxE) new Chart(ctxE, {
                type: 'doughnut',
                data: { labels: ['Excelente (‚â•80%)','Bueno (60-79%)','Regular (40-59%)','Cr√≠tico (<40%)'], datasets: [{ data: [stats.excelente, stats.bueno, stats.regular, stats.critico], backgroundColor: ['#10b981','#84cc16','#f59e0b','#ef4444'], borderWidth: 2, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } }, datalabels: { color: '#fff', font: { weight: 'bold', size: 13 }, formatter: (v, ctx) => { if (!v) return ''; const t = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); return `${v}\n(${((v/t)*100).toFixed(1)}%)`; } } } },
                plugins: [ChartDataLabels]
            });

            // Barras avance
            const secLabels = secs.map(s => s.replace('Secretaria de ','').replace('Sec de ','').replace('Sec ',''));
            const secAvances = secs.map(s => statsSecretaria(s).avancePromedio.toFixed(1));
            const colores = secs.map(s => colorBorde(statsSecretaria(s).avancePromedio/100));

            const ctxA = document.getElementById('chartAvances');
            if (ctxA) new Chart(ctxA, {
                type: 'bar',
                data: { labels: secLabels, datasets: [{ label: 'Avance %', data: secAvances, backgroundColor: colores.map(c=>c+'99'), borderColor: colores, borderWidth: 2 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#1e3a8a', font: { weight: 'bold', size: 12 }, formatter: v => v + '%' } }, scales: { x: { beginAtZero: true, max: 110, ticks: { callback: v => v + '%' } } } },
                plugins: [ChartDataLabels]
            });

            // Barras # programas
            const ctxS = document.getElementById('chartSecretarias');
            if (ctxS) new Chart(ctxS, {
                type: 'bar',
                data: { labels: secLabels, datasets: [{ label: 'Programas', data: secs.map(s => getProgramas(s).length), backgroundColor: 'rgba(59,130,246,0.8)', borderColor: 'rgba(59,130,246,1)', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#1e3a8a', font: { weight: 'bold', size: 12 }, formatter: v => v } }, scales: { y: { beginAtZero: true } } },
                plugins: [ChartDataLabels]
            });

            // Barras a√±os
            const a√±os = ['2024','2025','2026'];
            const promedios = a√±os.map(anio => {
                let suma=0, count=0;
                window.programasDB.forEach(p => {
                    const d = p[`anio_${anio}`];
                    const meta = parseFloat(d?.meta)||0;
                    const av = parseFloat(d?.avance)||0;
                    if (meta > 0) { suma += Math.min(av/meta, 1.2); count++; }
                });
                return count > 0 ? ((suma/count)*100).toFixed(1) : 0;
            });

            const ctxAnios = document.getElementById('chartAnios');
            if (ctxAnios) new Chart(ctxAnios, {
                type: 'bar',
                data: { labels: a√±os, datasets: [{ label: '% Cumplimiento Promedio', data: promedios, backgroundColor: ['rgba(59,130,246,0.8)','rgba(16,185,129,0.8)','rgba(245,158,11,0.5)'], borderColor: ['rgb(59,130,246)','rgb(16,185,129)','rgb(245,158,11)'], borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#1e3a8a', font: { weight: 'bold', size: 12 }, formatter: v => v + '%' } }, scales: { y: { beginAtZero: true, max: 120, ticks: { callback: v => v + '%' } } } },
                plugins: [ChartDataLabels]
            });
        }

        // ============================================================
        // SECRETAR√çA
        // ============================================================
        function mostrarSecretaria(nombre) {
            const progs = getProgramas(nombre);
            const s = statsSecretaria(nombre);
            const icono = iconoSec(nombre);
            const color = colorBorde(s.avancePromedio/100);
            const linea = progs.length > 0 ? (progs[0].linea_estrategica || '') : '';

            let html = `
            <div class="fade-in">
                <div class="secretaria-detalle-header">
                    <span class="secretaria-detalle-icono">${icono}</span>
                    <div>
                        <h2>${nombre}</h2>
                        <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-top:4px;">${linea}</div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon">üìã</div>
                        <div class="kpi-value">${s.total}</div>
                        <div class="kpi-label">Total Programas</div>
                    </div>
                    <div class="kpi-card kpi-card-wide">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-value">${s.avancePromedio.toFixed(1)}%</div>
                        <div class="kpi-label">Avance Plan de Desarrollo</div>
                        <div class="kpi-progress-mini">
                            <div class="kpi-progress-bar">
                                <div class="kpi-progress-fill" style="width:${Math.min(s.avancePromedio,100)}%;background:${color};"></div>
                            </div>
                            <div class="kpi-progress-labels">
                                <span class="label-avance">‚úì ${s.avancePromedio.toFixed(1)}%</span>
                                <span class="label-faltante">‚è≥ ${(100-s.avancePromedio).toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">‚úÖ</div>
                        <div class="kpi-value">${s.completados}</div>
                        <div class="kpi-label">Completados</div>
                        <div class="stat-description">‚â•100%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">‚ö†Ô∏è</div>
                        <div class="kpi-value">${s.enRiesgo}</div>
                        <div class="kpi-label">En Riesgo</div>
                        <div class="stat-description">&lt;40%</div>
                    </div>
                </div>

                <div class="charts-container" style="grid-template-columns:1fr 1fr;">
                    <div class="chart-card"><h3>üìä Avance Plan de Desarrollo</h3><div class="chart-wrapper"><canvas id="chartSecEstado"></canvas></div></div>
                    <div class="chart-card"><h3>üìÖ Avance Anual Plan de Acci√≥n</h3><div class="chart-wrapper"><canvas id="chartSecAnios"></canvas></div></div>
                </div>

                <h3 style="font-size:22px;font-weight:700;color:#1e3a8a;margin:32px 0 20px;">üìã Programas (${progs.length})</h3>
            `;

            progs.forEach((prog, i) => { html += renderPrograma(prog, i+1); });
            html += '</div>';
            document.getElementById('contentArea').innerHTML = html;
            setTimeout(() => renderGraficosSecretaria(progs), 100);
        }

        function renderGraficosSecretaria(progs) {
            ['chartSecEstado','chartSecAnios'].forEach(id => { const ex = Chart.getChart(id); if (ex) ex.destroy(); });

            let ex=0, bu=0, re=0, cr=0;
            progs.forEach(p => {
                const pct = parseFloat(p.pct_avance_fecha)||0;
                if (pct>=0.8) ex++; else if (pct>=0.6) bu++; else if (pct>=0.4) re++; else cr++;
            });

            const ctxE = document.getElementById('chartSecEstado');
            if (ctxE) new Chart(ctxE, {
                type: 'doughnut',
                data: { labels: ['Excelente','Bueno','Regular','Cr√≠tico'], datasets: [{ data: [ex,bu,re,cr], backgroundColor: ['#10b981','#84cc16','#f59e0b','#ef4444'], borderWidth: 2, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 10, font: { size: 11 } } }, datalabels: { color: '#fff', font: { weight: 'bold', size: 12 }, formatter: (v, ctx) => { if (!v) return ''; const t = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); return `${v}\n(${((v/t)*100).toFixed(0)}%)`; } } } },
                plugins: [ChartDataLabels]
            });

            const a√±os = ['2024','2025','2026'];
            const promedios = a√±os.map(anio => {
                let suma=0, count=0;
                progs.forEach(p => {
                    const d = p[`anio_${anio}`];
                    const meta = parseFloat(d?.meta)||0;
                    const av = parseFloat(d?.avance)||0;
                    if (meta > 0) { suma += Math.min(av/meta, 1.2); count++; }
                });
                return count > 0 ? ((suma/count)*100).toFixed(1) : 0;
            });

            const ctxA = document.getElementById('chartSecAnios');
            if (ctxA) new Chart(ctxA, {
                type: 'bar',
                data: { labels: a√±os, datasets: [{ label: '% Cumplimiento', data: promedios, backgroundColor: ['rgba(59,130,246,0.8)','rgba(16,185,129,0.8)','rgba(245,158,11,0.5)'], borderColor: ['rgb(59,130,246)','rgb(16,185,129)','rgb(245,158,11)'], borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#1e3a8a', font: { weight: 'bold', size: 12 }, formatter: v => v + '%' } }, scales: { y: { beginAtZero: true, max: 120, ticks: { callback: v => v + '%' } } } },
                plugins: [ChartDataLabels]
            });
        }

        // ============================================================
        // RENDER PROGRAMA
        // ============================================================
        function renderPrograma(prog, numero) {
            const pct = parseFloat(prog.pct_avance_fecha) || 0;
            const pctDisplay = (pct * 100).toFixed(1);
            const color = colorBorde(pct);
            const colorClass = pct>=0.8 ? 'success' : pct>=0.6 ? 'good' : pct>=0.4 ? 'warning' : 'danger';
            const etiqueta = pct>=0.8 ? 'Excelente' : pct>=0.6 ? 'Bueno' : pct>=0.4 ? 'Regular' : 'Cr√≠tico';

            const a24 = prog.anio_2024 || {};
            const a25 = prog.anio_2025 || {};
            const a26 = prog.anio_2026 || {};
            const a27 = prog.anio_2027 || {};

            return `
            <div class="card-programa">
                <div class="programa-header">
                    <div class="programa-titulo">
                        ${prog.componente ? `<div class="programa-componente"><strong>Componente:</strong> ${prog.componente}</div>` : ''}
                        <h3>${numero}. ${prog.programa || 'Sin nombre'}</h3>
                    </div>
                    <span class="badge badge-${colorClass}">${pctDisplay}% Avance al Plan - ${etiqueta}</span>
                </div>

                <table class="info-table">
                    <tr><td>C√≥digo de Producto</td><td>${prog.codigo || 'N/A'}</td></tr>
                    <tr><td>Indicador de Producto</td><td>${prog.indicador || 'N/A'}</td></tr>
                    <tr><td>Unidad de Medida</td><td>${prog.unidad || 'N/A'}</td></tr>
                    <tr><td>Tendencia</td><td>${prog.tendencia || 'N/A'}</td></tr>
                    <tr><td>L√≠nea Base</td><td>${fmt(prog.linea_base)}</td></tr>
                    <tr><td>Meta Cuatrienio</td><td><strong>${fmt(prog.meta_cuatrenio)}</strong></td></tr>
                </table>

                <div class="anios-container">
                    <h4 style="margin:16px 0 10px;color:#1e3a8a;font-size:15px;font-weight:700;">üìÖ Avance por A√±o</h4>
                    <div class="tabla-anios-wrapper">
                        <table class="tabla-anios">
                            <thead>
                                <tr><th>A√±o</th><th>Meta</th><th>Avance</th><th>% Cumpl. Anual</th><th>% Aporte al PD</th></tr>
                            </thead>
                            <tbody>
                                ${filaAnio('2024', a24)}
                                ${filaAnio('2025', a25)}
                                ${filaAnio('2026', a26)}
                                ${filaAnio27(a27)}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span>Avance Acumulado al Plan de Desarrollo</span>
                        <span>${pctDisplay}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${Math.min(pctDisplay,100)}%;background:${color};">
                            ${parseFloat(pctDisplay) >= 15 ? pctDisplay + '%' : ''}
                        </div>
                    </div>
                    <div style="font-size:12px;color:#6b7280;margin-top:4px;">
                        Avance acumulado 2024-2025: <strong>${fmt(prog.avance_acumulado)}</strong> / Meta cuatrienio: <strong>${fmt(prog.meta_cuatrenio)}</strong>
                    </div>
                </div>
            </div>`;
        }

        function filaAnio(anio, d) {
            const meta = parseFloat(d?.meta)||0;
            const av = parseFloat(d?.avance)||0;
            const pctC = parseFloat(d?.pct_cumplimiento)||0;
            const pctPD = parseFloat(d?.pct_avance_pd)||0;
            const color = pctC >= 1 ? '#10b981' : pctC >= 0.6 ? '#f59e0b' : pctC > 0 ? '#ef4444' : '#9ca3af';
            const bg = pctC === 0 ? '' : `background:${color}15;`;
            return `<tr style="${bg}">
                <td><strong>${anio}</strong></td>
                <td>${fmt(meta)}</td>
                <td style="color:${color};font-weight:600;">${fmt(av)}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="color:${color};font-weight:700;">${(pctC*100).toFixed(1)}%</span>
                        <div style="flex:1;background:#e5e7eb;border-radius:4px;height:6px;min-width:60px;">
                            <div style="width:${Math.min(pctC*100,100)}%;height:6px;background:${color};border-radius:4px;"></div>
                        </div>
                    </div>
                </td>
                <td style="color:#1e3a8a;">${(pctPD*100).toFixed(2)}%</td>
            </tr>`;
        }

        function filaAnio27(d) {
            const meta = parseFloat(d?.meta)||0;
            const av = parseFloat(d?.avance)||0;
            return `<tr style="opacity:0.65;">
                <td><strong>2027</strong></td>
                <td>${fmt(meta)}</td>
                <td>${fmt(av)}</td>
                <td><span style="color:#9ca3af;font-size:12px;">Pendiente</span></td>
                <td><span style="color:#9ca3af;font-size:12px;">Pendiente</span></td>
            </tr>`;
        }

        // ============================================================
        // INIT
        // ============================================================
        document.addEventListener('DOMContentLoaded', cargarDatosFirebase);
    </script>
</body>
</html>
