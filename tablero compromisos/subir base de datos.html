<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cargador de Compromisos ‚Äì Consejo de Gobierno</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family: system-ui, sans-serif;
  background:#f4f6f5;
  padding:2rem;
}
.card{
  max-width:1200px;
  margin:auto;
  background:white;
  padding:1.5rem;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.12);
}
h1{margin-top:0}
input,button{
  padding:.5rem;
  margin:.2rem 0;
}
button{
  background:#2fa87a;
  color:white;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}
button:disabled{background:#ccc}
.status{margin-top:1rem;font-weight:600}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:1rem;
  font-size:.8rem;
}
th,td{
  border:1px solid #ddd;
  padding:.4rem;
}
th{background:#f0f0f0}
.hidden{display:none}
</style>
</head>

<body>

<div class="card">

  <h1>üîê Cargador de Compromisos ‚Äì Consejo de Gobierno</h1>

  <!-- LOGIN -->
  <div id="loginBox">
    <h3>Iniciar sesi√≥n</h3>
    <input type="email" id="email" placeholder="Correo institucional"><br>
    <input type="password" id="password" placeholder="Contrase√±a"><br>
    <button onclick="login()">Ingresar</button>
    <div class="status" id="loginStatus"></div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <p><strong>Usuario autenticado:</strong> <span id="userEmail"></span></p>
    <button onclick="logout()">Cerrar sesi√≥n</button>
    <hr>

    <input type="file" id="file" accept=".xlsx"><br>
    <button id="btnSubir" disabled>Subir a Firebase</button>

    <div class="status" id="estado"></div>
    <div id="preview"></div>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBEYH9mlu_Jg41iQq2gAsdVlvlpggvoObQ",
  authDomain: "compromisos-22fa4.firebaseapp.com",
  projectId: "compromisos-22fa4",
  storageBucket: "compromisos-22fa4.firebasestorage.app",
  messagingSenderId: "873487761646",
  appId: "1:873487761646:web:a36b36794a515229d333ff"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= AUTH ================= */
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("userEmail").textContent = user.email;
  } else {
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("app").classList.add("hidden");
  }
});

function login(){
  const email = email.value;
  const password = password.value;

  auth.signInWithEmailAndPassword(email, password)
    .catch(err => {
      document.getElementById("loginStatus").textContent = err.message;
    });
}

function logout(){
  auth.signOut();
}

/* ================= EXCEL ================= */
let registros = [];

document.getElementById("file").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type: "binary" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

    registros = rows.slice(1)
      .filter(r => Number.isFinite(Number(r[0])))
      .map(f => ({
        no: Number(f[0]),
        fecha_reunion: f[1] || null,
        codigo: f[2],
        descripcion: f[3],
        responsables: [f[4], f[5], f[6]].filter(x => x),
        fecha_asignada: f[7] || null,
        fecha_compromiso: f[8] || null,
        cumplimiento: f[9],
        tipo_cumplimiento: f[10],
        observaciones: f[11],
        evidencias: f[12]
      }));

    document.getElementById("btnSubir").disabled = registros.length === 0;
    mostrarPreview();
  };
  reader.readAsBinaryString(e.target.files[0]);
});

/* ================= PREVIEW ================= */
function mostrarPreview(){
  let html = `<h3>Registros detectados: ${registros.length}</h3>
  <table>
    <tr>
      <th>No</th><th>Descripci√≥n</th><th>Responsables</th>
      <th>Cumplimiento</th><th>Tipo</th>
    </tr>`;
  registros.slice(0,10).forEach(r=>{
    html+=`<tr>
      <td>${r.no}</td>
      <td>${r.descripcion}</td>
      <td>${r.responsables.join("; ")}</td>
      <td>${r.cumplimiento}</td>
      <td>${r.tipo_cumplimiento}</td>
    </tr>`;
  });
  html+=`</table>`;
  preview.innerHTML = html;
}

/* ================= SUBIR ================= */
btnSubir.onclick = async ()=>{
  estado.textContent = "‚è≥ Subiendo datos‚Ä¶";
  try{
    for(const r of registros){
      await db.collection("compromisos").add({
        ...r,
        creado_en: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    estado.textContent = "‚úÖ Carga completada correctamente";
  }catch(err){
    console.error(err);
    estado.textContent = "‚ùå Error al subir datos (ver consola)";
  }
};
</script>

</body>
</html>
