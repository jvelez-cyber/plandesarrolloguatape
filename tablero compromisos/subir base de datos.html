<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Cargador de Compromisos a Firebase</title>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase + l√≥gica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // üî• CONFIGURACI√ìN FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyBEYH9mlu_Jg41iQq2gAsdVlvlpggvoObQ",
    authDomain: "compromisos-22fa4.firebaseapp.com",
    projectId: "compromisos-22fa4",
    storageBucket: "compromisos-22fa4.firebasestorage.app",
    messagingSenderId: "873487761646",
    appId: "1:873487761646:web:a36b36794a515229d333ff"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let dataExcel = [];

  // ‚úÖ EXPUESTO AL HTML
  window.leerExcel = function (input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = (e) => {
      const workbook = XLSX.read(e.target.result, { type: "binary" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      dataExcel = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      console.log("üìÑ Datos Excel:", dataExcel);

      document.getElementById("registros").innerText =
        `Registros detectados: ${dataExcel.length}`;
    };

    reader.readAsBinaryString(file);
  };

  // ‚úÖ EXPUESTO AL HTML
  window.subirFirebase = async function () {
    if (!dataExcel.length) {
      alert("‚ùå No hay datos cargados");
      return;
    }

    let contador = 0;

    for (const fila of dataExcel) {
      try {
        const compromiso = {
          no: fila["No"] || null,
          fecha_reunion: fila["Fecha reuni√≥n  (D-M-A)"] || "",
          codigo_actividad: fila["C√≥digo Actividad"] || "",
          descripcion: fila["Descripci√≥n"] || "",

          // üîπ RESPONSABLES COMO CAMPOS SEPARADOS
          responsable_1: fila["Responsable 1"] || "",
          responsable_2: fila["Responsable 2"] || "",
          responsable_3: fila["Responsable 3"] || "",

          fecha_asignada: fila["Fecha asignada cumplimiento  (D-M-A)"] || "",
          fecha_cumplimiento: fila["Fecha de cumplimiento (D-M-A)"] || "",
          cumplimiento: fila["Cumplimiento"] || "",
          valoracion: fila["Valoraci√≥n del Cumplimiento"] || "",
          evidencias: fila["Evidencias"] || "",
          observaciones: fila["Observaciones"] || "",
          creado_en: new Date()
        };

        console.log("‚¨ÜÔ∏è Subiendo:", compromiso);

        await addDoc(collection(db, "compromisos"), compromiso);
        contador++;

      } catch (error) {
        console.error("‚ùå Error al subir fila:", fila, error);
      }
    }

    alert(`‚úÖ ${contador} compromisos subidos correctamente`);
  };

  console.log("üî• Firebase y JS cargados correctamente");
</script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f4f6f9;
    padding: 2rem;
  }

  .card {
    background: #ffffff;
    padding: 2rem;
    border-radius: 12px;
    max-width: 900px;
    margin: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,.08);
  }

  h2 {
    margin-top: 0;
  }

  button {
    background: #2fa87a;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
  }

  button:hover {
    background: #27966d;
  }
</style>
</head>

<body>

<div class="card">
  <h2>üì§ Cargador de Compromisos a Firebase</h2>

  <input type="file" accept=".xlsx,.xls" onchange="leerExcel(this)">
  <br><br>

  <button onclick="subirFirebase()">Subir a Firebase</button>

  <p id="registros">Registros detectados: 0</p>
</div>

</body>
</html>
