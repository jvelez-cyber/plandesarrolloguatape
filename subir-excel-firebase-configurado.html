<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Excel a Firebase - Plan de Desarrollo Guatap√©</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 12px;
        }
        
        .header p {
            font-size: 16px;
            color: #718096;
        }
        
        .firebase-status {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .firebase-status-icon {
            font-size: 24px;
        }
        
        .file-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 48px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .file-upload.dragover {
            border-color: #667eea;
            background: #edf2f7;
            transform: scale(1.02);
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .file-text {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .file-subtext {
            font-size: 14px;
            color: #a0aec0;
        }
        
        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-box {
            margin-top: 24px;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .status-box.info {
            background: #bee3f8;
            color: #2c5282;
            display: block;
        }
        
        .status-box.success {
            background: #c6f6d5;
            color: #22543d;
            display: block;
        }
        
        .status-box.error {
            background: #fed7d7;
            color: #742a2a;
            display: block;
        }
        
        .progress-container {
            margin-top: 24px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 12px;
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        
        .stat-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .file-info-box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }
        
        .file-info-box.show {
            display: block;
        }
        
        .file-info-title {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .file-info-name {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ Subir Excel a Firebase</h1>
            <p>Plan de Desarrollo Municipal - Guatap√© 2024-2027</p>
        </div>
        
        <!-- Estado de Firebase -->
        <div class="firebase-status">
            <div class="firebase-status-icon">‚úÖ</div>
            <div>
                <strong>Firebase configurado correctamente</strong><br>
                Proyecto: plan-de-desarrollo-49495
            </div>
        </div>
        
        <!-- Carga de Archivo -->
        <div class="file-upload" id="fileUpload">
            <div class="file-icon">üìÅ</div>
            <div class="file-text">
                Arrastra tu archivo Excel aqu√≠
            </div>
            <div class="file-subtext">o haz clic para seleccionar</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
        </div>
        
        <!-- Informaci√≥n del archivo -->
        <div class="file-info-box" id="fileInfo">
            <div class="file-info-title">üìÑ Archivo seleccionado:</div>
            <div class="file-info-name" id="fileName"></div>
        </div>
        
        <!-- Bot√≥n de acci√≥n -->
        <button class="btn btn-primary" id="uploadBtn" disabled>
            <span>üì§</span>
            <span>Subir a Firebase (Colecci√≥n: plandesarrollo)</span>
        </button>
        
        <!-- Barra de progreso -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="progress-text" id="progressText">Procesando...</div>
        </div>
        
        <!-- Estado -->
        <div class="status-box" id="statusBox"></div>
        
        <!-- Estad√≠sticas -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statSuccess">0</div>
                <div class="stat-label">Subidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statFailed">0</div>
                <div class="stat-label">Fallidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTime">0s</div>
                <div class="stat-label">Tiempo</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK y Aplicativo -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Importar SheetJS para leer Excel
        import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs';
        
        // ============================================
        // CONFIGURACI√ìN DE FIREBASE (PRECONFIGURADA)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzP_NnuPmewAeOJ7IkJxkiSrHgpObz4cQ",
            authDomain: "plan-de-desarrollo-49495.firebaseapp.com",
            projectId: "plan-de-desarrollo-49495",
            storageBucket: "plan-de-desarrollo-49495.firebasestorage.app",
            messagingSenderId: "374569479398",
            appId: "1:374569479398:web:f718e47ee0ae0d8a439f27"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        console.log("‚úÖ Firebase inicializado correctamente");
        
        // Variables globales
        let excelData = null;
        
        // Elementos del DOM
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusBox = document.getElementById('statusBox');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statsGrid = document.getElementById('statsGrid');
        
        // Event Listeners para drag and drop
        fileUpload.addEventListener('click', () => fileInput.click());
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // Manejar archivo
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('error', 'Por favor selecciona un archivo Excel v√°lido (.xlsx o .xls)');
                return;
            }
            
            fileName.textContent = file.name;
            fileInfo.classList.add('show');
            
            // Leer archivo Excel
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    processExcelData(workbook);
                    uploadBtn.disabled = false;
                    showStatus('info', `‚úÖ Archivo cargado correctamente. ${excelData.length} programas encontrados. ¬°Listo para subir a Firebase!`);
                } catch (error) {
                    showStatus('error', `Error al leer el archivo: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Procesar datos del Excel
        function processExcelData(workbook) {
            excelData = [];
            const sheetNames = workbook.SheetNames.slice(0, 5); // Primeras 5 hojas (secretar√≠as)
            
            const columnMapping = {
                0: 'COMPONENTE',
                1: 'PROGRAMA',
                2: 'C√ìDIGO DE PRODUCTO',
                3: 'INDICADOR DE PRODUCTO',
                4: 'UNIDAD DE MEDIDA',
                5: 'TENDENCIA',
                6: 'META 2025',
                7: 'CANTIDAD DE EJECUCION DEL PROGRAMA (HASTA LA FECHA)',
                8: 'PORCENTAJE DE EJECUCION DEL  PROGRAMA (HASTA LA FECHA)',
                9: 'PORCENTAJE DE EJECUCI√ìN APORTE AL PDM (HASTA LA FECHA)',
                10: 'CANTIDAD DE EJECUCION  FALTANTE   APORTE AL PDM (HASTA LA FECHA)',
                11: 'PORCENTAJE DE EJECUCION FALTANTE  APORTE AL PDM (HASTA LA FECHA)',
                12: 'EVIDENCIA FINAL',
                13: 'VALOR PROGRAMADO EN PLAN PLURIANUAL DE INVERSIONES',
                14: 'VALOR PRESUPUESTO APROBADO',
                15: 'VALOR EJECUTADO',
                16: 'PORCENTAJE DE EJECUCI√ìN PRESUPUESTAL'
            };
            
            sheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
                
                // Encontrar fila de encabezado y procesar datos
                const dataRows = jsonData.slice(2); // Desde fila 2 en adelante
                
                dataRows.forEach(row => {
                    // Verificar si es un programa v√°lido
                    const programa = row[1] ? String(row[1]).trim() : '';
                    const codigoProducto = row[2];
                    
                    // Filtrar filas vac√≠as o de totales
                    if (!programa || programa === 'PROGRAMA' || programa.includes('Porcentaje Total')) {
                        return;
                    }
                    
                    // Verificar que sea un programa v√°lido
                    if (!programa.match(/^\d/) && !codigoProducto) {
                        return;
                    }
                    
                    // Crear objeto del programa
                    const programaObj = {
                        SECRETARIA: sheetName,
                        fechaSubida: new Date().toISOString()
                    };
                    
                    // Mapear columnas
                    Object.keys(columnMapping).forEach(colIndex => {
                        const fieldName = columnMapping[colIndex];
                        let value = row[parseInt(colIndex)];
                        
                        // Limpiar valores
                        if (value === null || value === undefined || value === '') {
                            value = null;
                        } else if (typeof value === 'string') {
                            value = value.trim();
                        }
                        
                        programaObj[fieldName] = value;
                    });
                    
                    excelData.push(programaObj);
                });
            });
            
            console.log(`üìä Programas extra√≠dos: ${excelData.length}`);
        }
        
        // Subir datos a Firebase
        uploadBtn.addEventListener('click', async () => {
            if (!excelData || excelData.length === 0) {
                showStatus('error', 'No hay datos para subir');
                return;
            }
            
            uploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            statsGrid.style.display = 'grid';
            
            const collectionName = 'plandesarrollo';
            const startTime = Date.now();
            
            let uploaded = 0;
            let failed = 0;
            
            try {
                const collectionRef = collection(db, collectionName);
                
                showStatus('info', '‚è≥ Subiendo programas a Firebase...');
                
                // Subir programas uno por uno
                for (let i = 0; i < excelData.length; i++) {
                    const programa = excelData[i];
                    const progress = Math.round(((i + 1) / excelData.length) * 100);
                    
                    // Actualizar UI
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    progressText.textContent = `Subiendo programa ${i + 1} de ${excelData.length}...`;
                    
                    try {
                        await addDoc(collectionRef, programa);
                        uploaded++;
                    } catch (error) {
                        console.error(`‚ùå Error al subir programa ${i + 1}:`, error);
                        failed++;
                    }
                    
                    // Actualizar stats
                    document.getElementById('statTotal').textContent = excelData.length;
                    document.getElementById('statSuccess').textContent = uploaded;
                    document.getElementById('statFailed').textContent = failed;
                }
                
                const endTime = Date.now();
                const timeSeconds = ((endTime - startTime) / 1000).toFixed(1);
                
                document.getElementById('statTime').textContent = timeSeconds + 's';
                
                showStatus('success', `üéâ ¬°Completado! ${uploaded} programas subidos exitosamente a Firebase en la colecci√≥n "plandesarrollo".`);
                
                if (failed > 0) {
                    showStatus('error', `‚ö†Ô∏è Atenci√≥n: ${failed} programas fallaron al subir.`);
                }
                
            } catch (error) {
                showStatus('error', `‚ùå Error durante la carga: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
            }
        });
        
        // Mostrar mensaje de estado
        function showStatus(type, message) {
            statusBox.className = 'status-box ' + type;
            statusBox.textContent = message;
            statusBox.style.display = 'block';
        }
    </script>
</body>
</html>
